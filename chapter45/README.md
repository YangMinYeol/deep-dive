# 프로미스

- 프로미스는 전통적인 콜백 패턴이 가진 단점을 보완하며 비동기 처리 시점울 명확하게 표현할 수 있다는 장점이있다.
- 프로미스는 비동기 처리 상태와 처리 결과를 관리하는 객체다.

## 콜백 헬

- 비동기 함수는 처리 결과를 외부에 반환할 수 없고, 상위 스코프의 변수에 할당할 수도 없다. 따라서 비동기 함수의 처리 결과(서버의 응답 등)에 대한 후속 처리는 비동기 함수 내부에서 수행해야 한다.
  > 이때 비동기 함수를 범용적으로 사용하기 위해 비동기 함수에 비동기 처리결과에 대한 후속 처리를 수행하는 콜백 함수를 전달하는 것이 일반적이다.
- 콜백 함수를 통해 비동기 처리 결과에 대한 후속 처리를 수행하는 비동기 함수가 비동기 처리 결과를 가지고 또다시 비동기 함수를 호출해야 한다면 콜백 함수 호출이 중첩되어 복잡도가 높아지는 현상이 발생하는데, 이를 `콜백 헬`이라 한다.
- `콜백 헬`은 가독성을 나쁘게 하며 실수를 유발하는 원인이 된다.

## 프로미스 생성

- Promise 생성자 함수가 인수로 전달받은 콜백 함수 내부에서 비동기 처리를 수행한다.
- 비동기 처리가 성공하면 콜백 함수의 인수로 전달받은 resolve 함수를 호출하고, 비동기 처리가 실패하면 reject 함수를 호출한다.
- 상태 정보
  | 프로미스의 상태 정보 | 의미 | 상태 변경 조건|
  | --- | ---| ---|
  |pending|비동기 처리가 아직 수행되지 않은 상태| 프로미스가 생성된 직후 기본 상태|
  |fulfilled|비동기 처리가 수행된 상태(성공)|resolve 함수 호출|
  |rejected|비동기 처리가 수행된 상태(실패)|reject 함수 호출|

## 프로미스의 후속 처리 메서드

- 프로미스의 비동기 처리 상태가 변화되면 후속 처리 메서드에 인수로 전달한 콜백 함수가 선택적으로 호출된다.
- 모든 후속 처리 메서드는 프로미스를 반환한다.

##### then

- 두 개의 콜백 함수를 인수로 받는다.
- 첫 번째 콜백 함수는 비동기 처리가 성공했을 때 호출되는 성공 처리 콜백 함수이며, 두 번째 콜백 함수는 비동기 처리가 실패했을 때 호출되는 실패 처리 콜백 함수다.

##### catch

- 한 개의 콜백 함수를 인수로 받는다.
- 프로미스가 rejected상태인 경우만 호출된다.

##### finally

- 한 개의 콜백 함수를 인수로 받는다.
- 프로미스의 성공 실패와 상관없이 무조건 한 번 호출된다.

## 프로미스의 에러 처리

- then 메서드에 두 번째 콜백 함수를 전달하는 것보다 catch 메서드를 사용하는 것이 가독성이 좋고 명확하다. 따라서 에러 처리는 then 메서드에서 하지 말고 catch 메서드에서 하는 것을 권장한다.

## 프로미스 체이닝

- 프로미스의 후속 처리 메서드는 언제나 프로미스를 반환하므로 연속적으로 호출할 수 있다. 이를 `프로미스 체이닝`이라 한다.

## 프로미스의 정적 메서드

##### resolve/reject

- 이미 존재하는 값을 래핑하여 프로미스를 생성하기 위해 사용한다.

##### all

- 여러 개의 비동기 처리를 모두 병렬처리할 때 사용한다.
- 처리 순서가 보장된다.
- 인수로 전달받은 배열의 프로미스가 하나라도 rejected 상태가 되면 나머지 프로미스가 fulfilled가 되는 것을 기다리지 않고 즉시 종료한다.

##### race

- 프로미스를 요소로 갖는 배열 등의 이터러블을 인수로 전달받는다.
- 가장 먼저 fulfilled 상태가 된 프로미스의 처리 결과를 resolve하는 새로운 프로미스를 반환한다.
- 인수로 전달받은 배열의 프로미스가 하나라도 rejected 상태가 되면 에러를 reject하는 새로운 프로미스를 즉시 반환한다.

##### allSettled

- 프로미스를 요소로 갖는 배열 등의 이터러블을 인수로 전달받는다.
- 전달받은 프로미스가 모두 settled 상태(비동기 처리가 수행된 상태)가 되면 처리 결과를 배열로 반환한다.
- 프로미스가 fulfilled 상태인 경우 비동기 처리 상태를 나타내는 status 프로퍼티와 처리 결과를 나타내는 value 프로퍼티를 갖는다.
- 프로미스가 rejected 상태인 경우 비동기 처리 상태를 나타내는 status 프로퍼티와 에러를 나타내는 reason 프로퍼티를 갖는다.

## 마이크로태스크 큐

- 마이크로태스크 큐는 태스크 큐와 별도의 큐다.
- 마이크로태스크 큐는 태스크 큐보다 우선순위가 높다.

## fetch

- fetch 함수는 XMLHttpRequest 객체보다 사용법이 간단하고 프로미스를 지원하기 때문에 비동기 처리를 위한 콜백 패턴의 단점에서 자유롭다.
- fetch 함수는 HTTP 응답을 나타내는 Response 객체를 래핑한 Promise 객체를 반환한다.
- fetch 함수가 반환하는 프로미스는 기본적으로 404,500 과 같은 HTTP 에러가 발생해도 애러를 reject하지 않고 불리언 타입의 ok상태를 false로 설정한 Response 객체를 resolve한다. 오프라인 등의 네트워크 장애나 CORS 에러에 의해 요청이 완료되지 못한 경우에만 프로미스를 reject 한다.
  > 따라서 fetch 함수가 반환한 프로미스가 resolve한 불리언 타입의 ok상태를 확인해 명시적으로 에러를 처리할 필요가 있다.
